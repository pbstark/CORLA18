\documentclass[12pt]{article}

\bibliographystyle{plainnat}
\usepackage{graphicx}
\usepackage{amssymb,amsmath,color}
\usepackage[breaklinks=true]{hyperref}
\usepackage[round]{natbib}
%\usepackage{amsthm}
%\usepackage{algorithm}
%\usepackage{algorithmicx}
%\usepackage[noend]{algpseudocode}
\newtheorem{thm}{Theorem}
\newtheorem{definition}{Definition}

\newcommand{\beq}{\begin{equation}}
\newcommand{\eeq}{\end{equation}}
\newcommand{\ben}{\begin{enumerate}}
\newcommand{\een}{\end{enumerate}}

\newcommand{\mc}[1]{\ensuremath{\mathcal{#1}}}
\newcommand{\mb}[1]{\ensuremath{\mathbb{#1}}}
\newcommand{\ul}[1]{\ensuremath{\underline{#1}}}
\newcommand{\RM}{\emph{RM}}
\newcommand{\A}{\emph{A}}
\newcommand{\B}{\emph{B}}
\newcommand{\C}{\emph{C}}
\newcommand{\EE}{\bb{E}}
\newcommand{\PP}{\bb{P}}
\newcommand{\bpi}{\bar{\pi}}
\newcommand{\bp}{\bar{p}}

\newcommand{\comment}[1]{}
\newcommand{\note}[1]{\textcolor{red}{\sc #1}}



\title{Preparing to Audit Colorado's 2018 Primaries}

\author{
   Mark Lindeman\\
   Neal McBurnett\\
   Kellie Ottoboni\\
   Ronald L.~Rivest\\
   Philip B.~Stark
}

\date{Draft \today}

\begin{document}
\maketitle


\begin{abstract}
Colorado's current audit software (RLATool) needs to be improved to audit partisan 
primaries in Colorado in 2018, even to draw the sample for the audit:
the current version of RLATool does not allow the user to select the sample size, nor does
it directly allow an unstratified random sample to be drawn across counties.
Similarly, RLATool needs to be modified to recognize that contests can cross jurisdictional
boundaries; currently, it treats every contest as if it were entirely
contained in a single county.
Margins and risk limits apply to entire contests, not to the portion of a contest
included in a county.
Second, to audit a contest that includes voters in ``legacy'' counties 
(counties with voting systems that cannot export cast vote records) 
and voters in counties with newer systems requires new statistics, if one wants to
keep the efficiency of ballot-level comparison audits that the newer systems
afford.
Third, auditing contests that appear only on a subset of ballots can
be made much more efficient if the sample can be drawn from just those ballots
that contain the contest.
While allowing samples to be restricted to ballots reported to contain a particular
is not essential for the June, 2018 primaries, it will be necessary
eventually to make it feasible to audit smaller contests.
\end{abstract}

\section{Introduction}
A risk-limiting audit (RLA) of an election is a procedure that
has a known, pre-specified minimum chance of correcting the electoral outcome if the outcome
is incorrect---that is, if the reported outcome differs from the outcome that a full manual
tabulation of the votes would find. 
RLAs require a durable, voter-verifiable record of voter intent, such as paper ballots,
and they assume that this audit trail is sufficiently complete and accurate that a full hand
tally would show the true electoral outcome.
That assumption is not automatically satisfied: a \emph{compliance audit} is required.

Risk-limiting audits are generally incremental: they examine more ballots, or batches of ballots,
until either (i)~there is strong statistical evidence that a full hand tabulation would confirm the outcome,
or (ii)~the audit has led to a full hand tabulation, the result of which becomes the official
result.

RLAs have been piloted in California, Colorado, and Ohio, and a test of
RLA procedures has been conducted in Arizona.
RLA bills are being drafted or are already under consideration in Virginia, Washington, and other states.
A number of laws have either allowed or mandated risk-limiting post election audits,
including California AB~2023 (Salda\~{n}a), SB~360 (Padilla), and AB~44 (Mullin);
Rhode Island SB~413A and HB~5704A; and Colorado Revised Statutes (CRS)~1-7-515.

CRS~1-7-515 required 
Colorado to implement risk-limiting audits beginning in 2017.
(There are provisions to allow the Secretary of State to exempt some counties.)
The first statewide risk-limiting election audits took place in Colorado in November, 2017. 

Colorado's ``uniform voting system'' program has led
many Colorado counties to purchase (or to plan to purchase) voting systems
that are auditable at the ballot level: those systems export cast vote records (CVRs)
for individual ballots in a manner that allows the corresponding paper ballot to be identified,
and conversely, make it possible to find the CVR corresponding to any
particular paper ballot.
We call counties that have such systems ``CVR'' counties.
It is estimated that by June, 2018, 98.2\% of active Colorado voters will be in CVR counties.
CVR counties can perform ``ballot-level comparisons,'' which are currently the
most efficient approach to risk-limiting audits in that they require examining
fewer ballots than other methods do, when the outcome of the contest under audit 
is in fact correct.

Other counties (``legacy'' or ``non-CVR'' counties) 
have systems that do not allow auditors to check how the system
interpreted voter intent for individual ballots.
Their election results can still be audited, provided their voting systems
create a voter-verifiable paper trail (\emph{e.g.}, voter-marked paper ballots) that is
conserved to ensure that it remains accurate and intact, and organized well enough
to permit ballots to be selected at random.
Pilot audits in California suggest that the most efficient way to audit such systems
is by ``ballot-polling''  
(in contrast to ``batch-level comparisons,'' for example).

There is currently no literature on how to perform risk-limiting audits 
of contests that include CVR counties and non-CVR counties by combining
ballot polling and ballot-level comparisons.
Existing methods would either require all counties to use the lowest
common denominator, ballot-polling (which does not take advantage of the CVRs,
and thus is expected to require more auditing than a method that does take
advantage of the CVRs), or would
require non-CVR counties to perform batch-level comparisons, which were found in
California to be (generally) less efficient than ballot-polling audits.

This document focuses on near-term requirements for risk-limiting audits in 
Colorado: June and November 2018.

\subsection{Colorado in June, 2018}
We understand that for June, 2018, Colorado Secretary of State Wayne Williams intends to require
a risk-limiting audit of at least one statewide contest in addition
to a countywide contest in each county.

Auditing efficiency is controlled in part by how well the audit sample can be focused on ballots that
contain the contests under audit.
Some contests are on (essentially) every ballot, for instance the governor's race.
Others, such as mayoral contests, may appear on only a small fraction of ballots cast in
a county.
Partisan primaries---even for statewide office---are somewhere in between,
because in general no single party's primary appears on every ballot cast in the state.
Thus, either we accept a cut to efficiency and sample ballots from counties (or collections of counties)
but keep the simplicity of being able to sample uniformly, or we develop a way to
focus the auditing on the ballots that contain the contest.
The latter requires external information, e.g., from SCORE, as discussed below.

Moreover, party primaries for statewide offices (and perhaps other contests) will
include CVR counties and non-CVR counties, so we need a method to audit
across mixed jurisdictional voting technology.

This report addresses both issues, providing a handful of ways of dealing with heterogeneous
voting technology, varying in efficiency, complexity, and on whom any additional audit burden falls.

\section{Crude (and unpleasant) approaches}

\subsection{Hand count the legacy counties}
The simplest approach to combining legacy counties with CVR counties is to require every
legacy county to do a full hand count of the primaries, and to conduct a 
ballot-level comparison audit in CVR counties, based on contest margins adjusted for
the results of the manual tallies in the CVR counties.
For instance, imagine a contest with two candidates, reported winner $w$ and reported loser $\ell$.
Suppose the total number of reported votes for candidate~$w$ is $V_w$ 
and the total for candidate~$\ell$ is $V_\ell$, so that $V_w > V_\ell$, since 
$w$ is the reported winner.
Suppose that a full manual tally of the votes in the legacy counties shows $V_w'$ votes for $w$ and
$V_\ell'$ votes for $\ell$.
Suppose that a total of $N$ ballots were cast in the CVR counties.
Then the diluted margin for the comparison audit in the CVR counties is 
$[(V_w-V_w')-(V_\ell-V_\ell')]/N$.
This approach is presumably unacceptable because it would require every legacy county to do a full hand
count. 
(But it would provide an incentive for those counties to upgrade their systems
sooner rather than later, and it does not penalize CVR counties for the fact that their
legacy siblings have not yet upgraded.)

\subsection{Subtract error bounds for the legacy counties from vote totals}
If ballot accounting and SCORE can give good upper bounds on the number of ballots cast in
each contest in legacy counties, there are simple upper bounds on the total
possible overstatement error each legacy county could contribute to the overall contest
results; those can be subtracted from the overall margin (as in the previous subsection) and the
remainder of the contests can be audited in CVR counties against the adjusted margins.
For instance, consider a primary that appears on $N$ ballots in a legacy counties.
Suppose that in legacy counties, the overall, statewide contest winner, $w$, is reported to have received $V_w'$ votes, and some loser, $\ell$, is reported to have received $V_\ell'$ votes. 
(Note that $V_\ell'$ could be greater than $V_w'$: $w$ is not necessarily the reported winner in the legacy counties.)
Then the most overstatement error that the county could possibly have in determining whether
$w$ in fact beat $\ell$ is if every reported undervote, invalid vote, or vote for a different candidate, $t$, had 
in fact been a vote for $\ell$ (producing a 1-vote overstatement), and every vote reported for 
$w$ was in fact a vote for $\ell$ (producing a 2-vote overstatement).
The reduction in the margin that would produce is 
$N - V_w' - V_\ell' + 2V_w' = N + V_w' - V_\ell'$ votes.

This approach may be unacceptable for at least two reasons:
first, if the margin is small, it could easily lead to a full hand count in every county.
Second, even if it doesn't lead to a full hand count, it penalizes CVR counties for the
fact that non-CVR counties have not upgraded their systems, because it reduces the
margin in every contest that includes a legacy county. 

\subsection{Treat legacy counties as if every ballot selected from them for audit has a two-vote overstatement}
A third simple-but-pessimistic approach is to sample uniformly from all counties as if one
were performing a ballot-level comparison audit everywhere,  but to 
treat any ballot
selected from a legacy county as a two-vote overstatement.
This approach is probably unacceptable for at least two reasons:
first, if the margin is small, it could easily lead to a full hand count in every county.
Second, even if it doesn't lead to a full hand count, it penalizes CVR counties for the
fact that non-CVR counties have not upgraded their systems, because it will require expanding
the sample (across all counties) every time a ballot is selected from a legacy county.


\section{Variable batch sizes}

A third approach is to perform a comparison audit across all counties, but to use batches consisting
of more than one ballot (batch-level comparisons)
in legacy counties and batches of a single ballot (ballot-level comparisons) in CVR counties.
The constraint here is that the non-CVR counties need to be able to report vote subtotals
for physically identifiable batches.
If a county's voting system can only report subtotals by precinct but 
the county does not sort paper ballots by
precinct, this approach might require revising how the county handles its
paper; we understand that this is the case in many Colorado counties.

That said, many California counties that do not sort vote-by-mail (VBM)
ballots by precinct conduct the statutory 1\% audits by manually retrieving the ballots 
for just those precincts selected for audit from whatever physical batches they happen to be in: 
the situation is identical to that in Colorado.

Another solution is the ``Boulder-style'' batch-level audit, which requires generating 
vote subtotals after each physical batch is scanned, and exporting those subtotals in machine-readable form.
That in turn may require using extra memory cards, repeatedly initializing and deleting tabulation databases,
or other measures that add complexity and opportunity for human error.

While those two approaches are laborious, they would provide a viable short-term solution,
especially combined with information from SCORE to check that the reported batch-level results contain the correct number of ballots for each contest under audit.
Moreover, it does not unduly increase the workload in CVR counties
to compensate for the fact that some other counties have not upgraded their voting
systems.

This kind of variable-batch-size comparison audit approach would require modifying or augmenting
RLATool in several ways: 

\begin{enumerate}

  \item the CVR reporting tool would need to be modified to allow non-CVR counties to
report batch-level results in a manner analogous to how CVR counties report
ballot-level results, or an external tool would need to be provided.

  \item the sampling
algorithm would have to allow sampling batches---and sampling them with unequal probability,
because efficient batch-level audits involve sampling batches with probability proportional
to a bound on the possible overstatement error in the batch.
It would also need to calculate the appropriate sampling probability for each batch (of whatever size).
Again, this could be accommodated using an external tool to draw the sample from legacy counties.

  \item the risk calculations would need to be modified. 
This, too, could be done with external software, with suitable provisions for capturing audit data
from RLATool or directly from legacy counties.
\end{enumerate}

None of these changes is enormous; the mathematics and statistics are already worked out
in published papers, and there is exemplar code for calculating the
batch-level error bounds, drawing the samples with probability proportional to an
error bound, and calculating the attained risk from the sample results.
Indeed, this is the method that was used in several of California's pilot audits,
including the audit in Orange County.
A derivation of a method for comparison audits with variable batch sizes is given below
in section~\ref{sec:comparisonError}.

\section{Stratified ``hybrid'' audits}

Other approaches involve \emph{stratification}: partitioning the cast ballots
into non-overlapping groups and sampling independently from those groups.
One could stratify by county, but in general it is simpler and more efficient
statistically (i.e., results in auditing fewer ballots) to minimize the number of strata.
We consider methods that use two strata: CVR counties and non-CVR counties. 
Collectively, the ballots cast in CVR counties comprise one stratum and the ballots cast in 
legacy counties comprise a second stratum; every ballot cast in the contest is in 
exactly one of the two strata. 
We assume that the samples are drawn from the
two strata independently.

\subsection{Partitioning the total permissible overstatement into strata}
The simplest approach to stratification involves partitioning the risk limit and the tolerable
overstatement error of the tabulation into
two pieces, one for the (pooled) CVR counties and one for the (pooled) non-CVR counties.
Let $V_{w\ell} > 0$ denote the contest-wide margin (in votes) of reported winner 
$w$ over reported loser
$\ell$.
Let $V_{w\ell,s}$ denote the margin (in votes) of reported winner $w$ over reported loser $\ell$
in stratum $s$. 
Note that $V_{w\ell,s}$ might be negative in one stratum.
Let $A_{w\ell}$ denote the margin (in votes)
of reported winner $w$ over reported loser $\ell$ that 
a full hand count of the entire contest would show, that is, the \emph{actual} margin rather
than the \emph{reported} margin.
Reported winner $w$ really beat reported loser $\ell$ if and only if $A_{w\ell} > 0$.
Define $A_{w\ell,s}$ to be the actual margin (in votes) of $w$ over $\ell$ in stratum $s$;
this too may be negative.

Let $\omega_{w\ell,s} \equiv V_{w\ell,s} - A_{w\ell,s}$ be the \emph{overstatement}
of the margin of $w$ over $\ell$ in stratum $s$.
Reported winner $w$ really beat reported loser 
$\ell$ iff $\omega_{w\ell} \equiv \omega_{w\ell,1} + \omega_{w\ell,2} < V_{w\ell}$.

Pick $\lambda_1 \in \Re$ and define $\lambda_2 = 1-\lambda_1$.
If $\omega_{w\ell,1} < \lambda_1 V_{w\ell}$ \emph{and} 
$\omega_{w\ell,2} < \lambda_2 V_{w\ell}$, candidate $w$ really received more votes
than candidate $\ell$.
Some pairs can be ruled out \emph{a priori}, because (for instance) $\omega_{w\ell,s} \in [-2N_s, 2N_s]$,
where $N_s$ is the number of ballots cast in stratum $s$.
There are other simple, sharper bounds, sketched below.

The choice of $\lambda_1$, the strata risk limits $\{\alpha_s\}$, and details of the
audit procedures affect the workload and the overall risk limit.
(See section~\ref{sec:stratumRisk}.)

For ballot-level comparison audits, auditing to ensure that $\omega_{w\ell,s} < \lambda_s V_{w\ell}$
is discussed in section~\ref{sec:comparisonError}; it is a minor modification of the method
embodied in RLATool.

For ballot-polling audits, auditing to ensure that $\omega_{w\ell,s} < \lambda_s V_{w\ell}$ is discussed in section~\ref{sec:ballotPollError}.
Note that this requires a more substantial modification of the standard ballot-polling calculations,
because the standard calculations consider only the fraction of ballots with a vote for either 
$w$ or $\ell$ that contain a vote for $w$, while we need to make an inference about the 
difference between the number of votes for $w$ and the number of votes for $\ell$.
This introduces an additional nuisance parameter, the number of ballots with votes for either
$w$ or $\ell$.

\input{stratumRisk}
\input{totalAcrossStrata}
\input{subcollections}
\input{comparisonError}
\input{ballotPollError}

We propose a conservative test as follows. 
Suppose that the outcome is incorrect (this is the null hypothesis).
Then there is error in the tabulation of votes in one or both strata such that, net,
the tabulation errors in the two strata combine to favor the reported winner(s)
by at least the reported margin(s).

We consider a single contest and assume that the
social choice function is plurality (first-past-the-post)
or vote for $k$ of $C$ candidates (e.g., a city council election).
Those restrictions can be relaxed somewhat; in particular, slight modifications allow
the approach to work with majority, super-majority, approval, and Borda.

There are two collections of ballots, $\mc{B}_1$, which contains $N_1$ ballots, 
and $\mc{B}_2$, which contains $N_2$ ballots.
The total number of ballots is $N \equiv N_1 + N_2$.
We also refer to the two collections as \emph{strata}.

There are $C$ candidates.
The set $\mc{W}$ are the candidates reported to have won; the set $\mc{L}$ are those
reported to have lost.
For the social choice function under consideration, candidate~$i$ belongs in $\mc{W}$ if and
only if she is reported to have received more votes than every candidate in $\mc{L}$.
We audit by looking at (winner, loser) pairs.
The audit stops when there is sufficiently strong statistical evidence that each winner 
$w \in \mc{W}$ in fact received more votes
than each loser $\ell \in \mc{L}$.

Let $\pi_s^c$ denote the fraction of ballots in stratum $s$ that show a vote for candidate $c$.
The total number of votes for candidate $c$ is $N_1 \pi_1^c + N_2 \pi_2^c$.
Candidate $w \in \mc{W}$ really beat candidate $\ell \in \mc{L}$ if and only if
\beq
    \sum_{s=1}^2 N_s \pi_s^w > \sum_{s=1}^2 N_s \pi_s^\ell,
\eeq
or, equivalently, iff
\beq
    \sum_{s=1}^2 N_s (\pi_s^w-\pi_s^\ell) > 0.
\eeq
To simplify the notation, for any $\pi \equiv (\pi_1, \pi_2)$, define 
\beq
    \bpi \equiv \frac{1}{N}\sum_{s=1}^2 N_s \pi_s,
\eeq
and for $p \equiv (p_1, p_2)$, define $\bp$ analogously.
Then candidate $w \in \mc{W}$ really beat candidate $\ell \in \mc{L}$ if and only if
$\bpi^w > \bpi^\ell$.

There are a variety of ways to proceed; we sketch two here and visit others below.


\subsection{Ballot polling for the weighted sum of proportions}
The first approach is to test the hypothesis 
$\bpi^w \le \bpi^\ell$ for every $(w, \ell)$ pair.
Unstratified ballot-polling audits are based on the conditional 
probability that a randomly selected
ballot shows a vote for $w$, given that it shows a vote for $w$ or for $\ell$
\citep{lindemanStark12,lindemanEtal12}.
If that conditional probability is larger than $1/2$, $w$ really received more votes than
$\ell$.

Because the fraction of ballots that do not show a vote for either $w$ or $\ell$ can differ
between strata, the conditional probabilities in the two strata separately are not enough
to tell whether $w$ really beat $\ell$: one also needs to know the total number of ballots with votes 
for either $w$ or for $\ell$ in each stratum.
Those numbers could be estimated from the same samples used to estimate the conditional 
probabilities, but the uncertainty of those estimates would need to be taken into account, and 
because of the dependence between the estimated fraction of ballots for $w$ among those for $w$ or $\ell$
and the estimated number of ballots for either $w$ or $\ell$, that is difficult to do in a sharp way.

In this section, to illustrate the germ of the approach,
we assume for simplicity that the contest is a plurality contest with $C=2$ candidates and
that every ballot
has a valid vote either for $w$ or for $\ell$, but not for both, so there are $N$ valid votes in all.
This assumption rules out undervotes and invalid ballots, which need to be taken into
account in real elections. 
We show below in section~\ref{sec:trinomial} how that can be done.

The reported winner purportedly received a fraction $p_s^w$ of the votes in stratum $s$.
Thus $\bp^w > \bp^\ell$ and $N_1 p_1^w + N_2p_2^w > N/2$.
In stratum $s$, we use Wald's sequential probability ratio test (SPRT) to
test the hypothesis that $\pi_s^w = p_s$ against the alternative hypothesis 
that the reported results are correct, that is, that $\pi_s^w = p_s^w$.


\subsection{Ballot polling without replacement, no undervotes or invalid ballots}
The mathematics in this section essentially 
recapitulates~\citet[pp43--44]{wald45} in different notation, with some simplifications.

There is a population of $N$ items. 
Item $j$ has ``value'' $a_j \in \{0, 1\}$. 

We want to test the hypothesis $H_0$ that $\frac{1}{N}\sum_j a_j = 1/2$ against the
alternative hypothesis $H_1$ that $\frac{1}{N}\sum_j a_j = \gamma$, for some
fixed $\gamma > 1/2$.

We will draw items sequentially, without replacement, such that the chance that 
item~$i$ is selected in draw $j$, assuming it has not been selected already, is $1/(N-j+1)$.
Let ${\mathcal B_{j-1}}$ be the indices of the items selected up to and including the $j-1$st draw,
and ${\mathcal B_0} \equiv \emptyset$. 

Let $\mathbb B_j$ denote the index of the item selected at random in the $j$th draw.

The chance that the first draw ${\mathbb B_1}$ gives an item with value 1, i.e., 
$\Pr \{a_{\mathbb B_1} = 1\}$, is $\frac{1}{N}\sum_b a_b$.
Under $H_0$, this chance is $p_{01} = 1/2$; under $H_1$, this chance is 
$p_{11} = \gamma$.

Given the values of $\{a_{\mathbb B_k}\}_{k=1}^i$, the conditional
probability that the $i$th draw gives an item with value 1 is

$$
   \Pr \{a_{\mathbb B_i} = 1 | {\mathcal B_{i-1}} \} = \frac{ \sum_{b \notin {\mathcal B_{i-1}}} a_b}{N-i+1}.
$$

Under $H_0$, this chance is

$$
   p_{0i} =  \frac{N/2 - \sum_{b \in {\mathcal B_{i-1}}} a_b}{N - i + 1}.
$$

Under $H_1$, this chance is

$$
   p_{1i} = \frac{N \gamma - \sum_{b \in {\mathcal B_{i-1}}} a_b}{N - i+1}.
$$

Let $X_i$ be the indicator of the event that the $i$th draw gives an item with
value $1$, i.e., the indicator of the event $a_{\mathbb B_i} = 1$.
The likelihood ratio for a given sequence $\{X_k\}_{k=1}^i$ is

$$
    \mbox{LR} = \frac{\prod_{k=1}^i p_{1k}^{X_k}(1-p_{1k})^{1-X_k}}
         {\prod_{k=1}^i p_{0k}^{X_k}(1-p_{0k})^{1-X_k}}.
$$

This can be simplified. 
Note that $p_{0k}$ and $p_{1k}$ have the same denominator,
$N - k + 1$, and that the numerators share a term.
Define $A(k) \equiv \sum_{b \in {\mathcal B_{i-1}}} a_b$.
Then

$$
    \mbox{LR} = \prod_{k=1}^i 
    \left ( \frac{N/2 - A(k)}{N\gamma - A(k)} \right )^{X_k}
    \left ( \frac{N-N/2 - (k-1-A(k))}{N-N\gamma - (k - 1 - A(k))} \right )^{1-X_k}
$$
$$
   = \prod_{k=1}^i  \left ( \frac{N/2 - A(k)}{N\gamma - A(k)} \right )^{X_k}
    \left ( \frac{N/2 - k + 1 + A(k)}{N(1-\gamma) - k + 1 + A(k)} \right )^{1-X_k}
$$

If $H_0$ is true, the chance that $\mbox{LR}$ is ever greater than $1/\alpha$
is at most $\alpha$.

\subsection{Ballot polling without replacement, accounting for undervotes and invalid votes}
Suppose that the population contains $N_w$ ballots with a valid vote for $w$ but not $\ell$,
$N_\ell$ ballots with a valid vote for $\ell$ but not $w$, and $N_u$ ballots with votes for both
$w$ and $\ell$ or for neither $w$ nor $\ell$.
Then $N = N_w + N_\ell + N_u$.
Let $N_{w\ell} \equiv N_w + N_\ell$ be the number of ballots in the 
population with a valid vote for $w$ or $\ell$ but not both.

Suppose we have made $k$ draws from the pool of ballots and have observed $n_w(k)$ votes for the reported winner, 
$n_\ell(k)$ votes for the reported loser, 
and $n_U(k)$ votes for other candidates or invalid votes.
$n_w(k)+n_\ell(k)+n_U(k) = k$.

The probability that the $k+1$st ballot is for the reported winner, conditional on all the previously observed ballots, is

$$\mathbb{P}(X_{k+1} = w \mid  n_w(k), n_\ell(k), n_U(k)) = \frac{\text{\# ballots for w not yet drawn}}{N - k}$$

Under the null, the number of votes for candidate $w$ remaining is $\frac{N_{w\ell}}{2} - n_w(k)$.  
Under the alternative, the number is $\frac{N_{w\ell}}{2} + \mu - n_w(k)$ for $\mu > 0$.
Thus, the likelihood ratio for observing a vote for candidate $w$, conditional on the previous ballots, is

$$LR_{k+1}(w) = \frac{\frac{N_{w\ell}}{2} - n_w(k)}{\frac{N_{w\ell}}{2}+\mu - n_w(k)}.$$

By the same reasoning, the likelihood ratio for observing a vote for the reported loser, conditional on the previous ballots, is

$$LR_{k+1}(\ell) = \frac{\frac{N_{w\ell}}{2} - n_\ell(k)}{\frac{N_{w\ell}}{2}-\mu - n_\ell(k)}.$$

The fraction of invalid ballots in the population is the same under the null and alternative, therefore the likelihood ratio for drawing an invalid ballot is always equal to 1. Therefore, at step $k+1$, the overall likelihood ratio is

$$LR_{k+1} = \prod_{i=1}^{k+1} LR_i(w)^{\mathbb{I}(X_i= w)}LR_i(\ell)^{\mathbb{I}(X_i = \ell)}.$$

More compactly, the likelihood ratio of the null to the alternative (assuming $N_{w\ell}$ is even) is
\beq
   \mbox{LR} = \frac{ {N_{w\ell}/2 \choose n_w}{N_{w\ell}/2 \choose n_\ell}}
           {{N_{w\ell}/2+\mu \choose n_w}{N_{w\ell}/2-\mu \choose n_\ell}}.
\eeq

The likelihood ratio is a function of the nuisance parameter $N_{w\ell}$.
The test is conservative when the likelihood ratio is maximized, which occurs when $N_{w\ell}$ is as large as possible. 
Given $n_U(k)$, we know that $N_{w\ell} \leq N - n_U(k)$.
This maximal value changes each time we observe a ballot that is not for the winner or loser.





\bibliography{./pbsBib}

\end{document}
